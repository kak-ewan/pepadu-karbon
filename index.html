<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEPADU KARBON - Media Pembelajaran</title>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }

        html, body {
            height: 100%;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100%;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .title {
            text-align: center;
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            text-align: center;
            color: #4a5568;
            font-size: 1.2rem;
            margin: 10px 0 0 0;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .user-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .level-badge {
            background: linear-gradient(45deg, #4299e1, #3182ce);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .time-display {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .welcome-screen, .assessment-screen, .learning-screen {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .welcome-message {
            text-align: center;
            font-size: 1.3rem;
            color: #2d3748;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }

        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.3);
        }

        .question-container {
            margin-bottom: 30px;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .options {
            display: grid;
            gap: 12px;
        }

        .option {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .option:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .option.selected {
            background: #ebf8ff;
            border-color: #4299e1;
            color: #2b6cb0;
        }

        .flipbook-container {
            background: #2d3748;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            position: relative;
            min-height: 600px;
        }

        .flipbook-page {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 0 auto;
            max-width: 800px;
            min-height: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: none;
            position: relative;
        }

        .flipbook-page.active {
            display: block;
        }

        .flipbook-page img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .flipbook-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .page-info {
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4a5568;
            font-size: 1.1rem;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #4299e1, #3182ce);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .assessment-progress {
            text-align: center;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .learning-menu {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .menu-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #e2e8f0;
            color: #4a5568;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: #cbd5e0;
        }

        .menu-btn.active {
            background: linear-gradient(45deg, #4299e1, #3182ce);
            color: white;
            border-color: #3182ce;
        }

        .content-section {
            display: block;
        }

        .content-section.hidden {
            display: none;
        }

        .video-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
        }

        .video-list {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .video-item {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .video-item:hover {
            border-color: #cbd5e0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .video-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            transition: background-color 0.3s ease;
        }

        .video-header:hover {
            background: #edf2f7;
        }

        .video-header h4 {
            margin: 0;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .video-content {
            display: none;
            padding: 0 20px 20px 20px;
            background: white;
        }

        .video-content.active {
            display: block;
        }

        .video-content.active .toggle-icon {
            transform: rotate(90deg);
        }

        .video-content video {
            width: 100%;
            max-width: 800px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .video-description {
            color: #4a5568;
            font-size: 0.95rem;
            line-height: 1.5;
            margin: 0;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
        }

        .notification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .notification-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .notification-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .notification-title {
            color: #2d3748;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .notification-message {
            color: #4a5568;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .btn-close {
            background: linear-gradient(45deg, #e53e3e, #c53030);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(229, 62, 62, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .flipbook-controls {
                flex-direction: column;
                gap: 15px;
            }

            .learning-menu {
                flex-direction: column;
                align-items: center;
            }

            .menu-btn {
                width: 200px;
            }

            .video-header {
                padding: 15px;
            }

            .video-header h4 {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="title">🌱 PEPADU KARBON</h1>
            <p class="subtitle">Media Pembelajaran Interaktif</p>
        </header>

        <div id="statusBar" class="status-bar hidden">
            <div class="user-info">
                <div class="info-item">
                    <span>👋 Halo, <strong id="studentName"></strong></span>
                </div>
                <div class="info-item">
                    <span>📊 Level:</span>
                    <span id="studentLevel" class="level-badge">Belum Dinilai</span>
                </div>
            </div>
            <div class="time-display">
                ⏱️ <span id="timeSpent">00:00:00</span>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="welcome-screen">
            <div class="welcome-message">
                <h2>🎓 Selamat datang, teman belajar!</h2>
                <p>Mari kita mulai perjalanan belajar tentang Pepadu Karbon bersama-sama. Sebelum memulai, silakan tulis nama kamu terlebih dahulu.</p>
            </div>
            
            <div class="input-group">
                <label for="nameInput">Nama Lengkap:</label>
                <input type="text" id="nameInput" placeholder="Masukkan nama lengkap kamu..." maxlength="50">
            </div>
            
            <button class="btn" onclick="submitName()">Mulai Belajar 🚀</button>
        </div>

        <!-- Assessment Screen -->
        <div id="assessmentScreen" class="assessment-screen hidden">
            <h2>📝 Asesmen Awal</h2>
            <p>Mari kita kenali level kemampuan kamu terlebih dahulu dengan beberapa pertanyaan.</p>
            
            <div class="assessment-progress">
                Pertanyaan <span id="currentQuestion">1</span> dari <span id="totalQuestions">8</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 20%"></div>
            </div>
            
            <div id="questionContainer" class="question-container">
                <div class="loading">
                    <div class="spinner"></div>
                    Memuat pertanyaan...
                </div>
            </div>
        </div>

        <!-- Learning Screen -->
        <div id="learningScreen" class="learning-screen hidden">
            <h2>📚 Materi Pembelajaran</h2>
            <p>Selamat! Sekarang kamu bisa mulai mempelajari materi Pepadu Karbon.</p>
            
            <!-- Learning Menu -->
            <div class="learning-menu">
                <button class="menu-btn active" onclick="showContent('flipbook')">📖 Flipbook</button>
                <button class="menu-btn" onclick="showContent('videos')">🎥 Video</button>
                <button class="menu-btn" onclick="showContent('games')">🎮 Games</button>
            </div>
            
            <!-- Flipbook Content -->
            <div id="flipbookSection" class="content-section">
                <div class="flipbook-container">
                    <div id="flipbookContent">
                        <div class="loading">
                            <div class="spinner"></div>
                            Memuat materi pembelajaran...
                        </div>
                    </div>
                    
                    <div id="flipbookControls" class="flipbook-controls hidden">
                        <button id="prevBtn" class="nav-btn" onclick="previousPage()">← Sebelumnya</button>
                        <div class="page-info">
                            Halaman <span id="currentPage">1</span> dari <span id="totalPages">1</span>
                        </div>
                        <button id="nextBtn" class="nav-btn" onclick="nextPage()">Selanjutnya →</button>
                    </div>
                </div>
            </div>
            
            <!-- Video Content -->
            <div id="videoSection" class="content-section hidden">
                <div class="video-container">
                    <h3>🎬 Video Pembelajaran</h3>
                    <p>Pilih video yang ingin kamu tonton untuk memperdalam pemahaman tentang Pepadu Karbon:</p>
                    
                    <div class="video-list">
                        <div class="video-item">
                            <div class="video-header" onclick="toggleVideo('video1')">
                                <h4>📹 Pentingnya Perubahan Iklim</h4>
                                <span class="toggle-icon">▶️</span>
                            </div>
                            <div id="video1" class="video-content">
                                <video controls preload="metadata">
                                    <source src="https://xppfmghrhhrejnopnyir.supabase.co/storage/v1/object/public/pepadu/Yuk%20Ketahui%20Pentingnya%20Perubahan%20Iklim!.mp4" type="video/mp4">
                                    Browser kamu tidak mendukung video HTML5.
                                </video>
                                <p class="video-description">Video ini menjelaskan mengapa perubahan iklim menjadi isu penting yang harus kita pahami dan tangani bersama.</p>
                            </div>
                        </div>
                        
                        <div class="video-item">
                            <div class="video-header" onclick="toggleVideo('video2')">
                                <h4>📹 Fakta Perubahan Iklim</h4>
                                <span class="toggle-icon">▶️</span>
                            </div>
                            <div id="video2" class="video-content">
                                <video controls preload="metadata">
                                    <source src="https://xppfmghrhhrejnopnyir.supabase.co/storage/v1/object/public/pepadu/Perubahan%20Iklim%20Kian%20Nyata,%20Ini%20Fakta%20yang%20Perlu%20Kamu%20Ketahui!.mp4" type="video/mp4">
                                    Browser kamu tidak mendukung video HTML5.
                                </video>
                                <p class="video-description">Pelajari fakta-fakta menarik tentang perubahan iklim yang sedang terjadi di sekitar kita.</p>
                            </div>
                        </div>
                        
                        <div class="video-item">
                            <div class="video-header" onclick="toggleVideo('video3')">
                                <h4>📹 Penyebab dan Dampak Emisi Karbon</h4>
                                <span class="toggle-icon">▶️</span>
                            </div>
                            <div id="video3" class="video-content">
                                <video controls preload="metadata">
                                    <source src="https://xppfmghrhhrejnopnyir.supabase.co/storage/v1/object/public/pepadu/Penyebab%20Emisi%20Karbon,%20Dampak%20Buruk%20dan%20Cara%20Menguranginya%20-%20Lindungi%20Hutan%20(360p,%20h264).mp4" type="video/mp4">
                                    Browser kamu tidak mendukung video HTML5.
                                </video>
                                <p class="video-description">Memahami penyebab emisi karbon, dampak buruknya, dan cara-cara untuk menguranginya demi melindungi hutan.</p>
                            </div>
                        </div>
                        
                        <div class="video-item">
                            <div class="video-header" onclick="toggleVideo('video4')">
                                <h4>📹 Apa Itu Emisi Karbon?</h4>
                                <span class="toggle-icon">▶️</span>
                            </div>
                            <div id="video4" class="video-content">
                                <video controls preload="metadata">
                                    <source src="https://xppfmghrhhrejnopnyir.supabase.co/storage/v1/object/public/pepadu/Apa%20Itu%20EMISI%20KARBON%20Dampak%20dari%20EMISI%20KARBON%20-%20Filda%20channel%20(360p,%20h264).mp4" type="video/mp4">
                                    Browser kamu tidak mendukung video HTML5.
                                </video>
                                <p class="video-description">Penjelasan lengkap tentang emisi karbon dan dampaknya terhadap lingkungan kita.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Games Content -->
            <div id="gamesSection" class="content-section hidden">
                <div class="video-container">
                    <div class="notification-icon" style="font-size: 6rem; text-align: center; margin-bottom: 20px;">🏫</div>
                    <h3 style="text-align: center; color: #2d3748; font-size: 1.8rem; margin-bottom: 20px;">Fitur Games Terbatas</h3>
                    <div style="text-align: center; background: #fff3cd; border: 2px solid #ffeaa7; border-radius: 12px; padding: 30px; margin: 20px 0;">
                        <p style="color: #856404; font-size: 1.2rem; line-height: 1.6; margin: 0;">
                            <strong>Maaf, fitur Games hanya dapat diakses ketika kamu berada di sekolah.</strong><br><br>
                            Silakan hubungi guru atau gunakan komputer sekolah untuk mengakses permainan edukatif tentang Pepadu Karbon.
                        </p>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <div style="background: #e8f5e8; border-radius: 12px; padding: 20px; margin: 20px 0;">
                            <h4 style="color: #2d5016; margin-bottom: 15px;">🎮 Yang Bisa Kamu Lakukan Sementara:</h4>
                            <ul style="color: #2d5016; text-align: left; max-width: 400px; margin: 0 auto;">
                                <li>Pelajari materi di Flipbook</li>
                                <li>Tonton video pembelajaran</li>
                                <li>Diskusikan dengan teman tentang jejak karbon</li>
                                <li>Praktikkan tips mengurangi emisi karbon</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script>
        // Global variables
        let studentData = {
            name: '',
            level: 'Belum Dinilai',
            hasAssessment: false,
            startTime: null,
            totalTime: 0,
            isActive: true
        };

        let assessmentQuestions = [
            {
                question: "Manakah yang merupakan sumber jejak karbon?",
                options: [
                    "Bernapas",
                    "Berjalan kaki",
                    "Kendaraan bermotor",
                    "Bersepeda"
                ],
                correct: 2,
                level: "Uni-struktural"
            },
            {
                question: "Apa tujuan utama mengurangi jejak karbon?",
                options: [
                    "Menghemat uang",
                    "Melindungi lingkungan",
                    "Membuat teknologi baru",
                    "Menambah populasi hewan"
                ],
                correct: 1,
                level: "Uni-struktural"
            },
            {
                question: "Manakah yang termasuk upaya mengurangi jejak karbon?\n\n1. Menggunakan transportasi umum\n2. Mematikan lampu saat tidak digunakan\n3. Membakar sampah\n4. Menanam pohon",
                options: [
                    "1, 2, dan 3",
                    "1, 2, dan 4",
                    "2, 3, dan 4",
                    "Semua benar"
                ],
                correct: 1,
                level: "Multi-struktural"
            },
            {
                question: "Urutkan dari yang jejak karbonnya TERBESAR ke TERKECIL:",
                options: [
                    "Pesawat → Mobil → Sepeda → Cidomo",
                    "Mobil → Sepeda → Cidomo → Pesawat",
                    "Sepeda → Cidomo → Mobil → Pesawat",
                    "Cidomo → Sepeda → Mobil → Pesawat"
                ],
                correct: 0,
                level: "Multi-struktural"
            },
            {
                question: "Mengapa makanan yang ditanam lokal memiliki jejak karbon lebih rendah daripada makanan impor?",
                options: [
                    "Karena lebih murah",
                    "Karena tidak membutuhkan transportasi jauh",
                    "Karena lebih sehat",
                    "Karena lebih enak"
                ],
                correct: 1,
                level: "Relasional"
            },
            {
                question: "Jika kita mengganti 10 km perjalanan mobil dengan sepeda, apa dampaknya terhadap jejak karbon?",
                options: [
                    "Jejak karbon meningkat",
                    "Jejak karbon berkurang",
                    "Jejak karbon tetap sama",
                    "Jejak karbon tidak terpengaruh"
                ],
                correct: 1,
                level: "Relasional"
            },
            {
                question: "Sebuah sekolah ingin mengurangi jejak karbon. Manakah strategi yang PALING EFEKTIF?",
                options: [
                    "Hanya mematikan lampu di kelas",
                    "Program \"hari bebas kendaraan bermotor\" + menanam cabai di sekolah",
                    "Membuat poster tentang lingkungan",
                    "Mengadakan lomba menggambar bumi"
                ],
                correct: 1,
                level: "Abstrak Meluas"
            },
            {
                question: "Jika seluruh siswa di Lombok menggunakan cidomo atau sepeda untuk pergi ke sekolah, apa dampak jangka panjangnya?",
                options: [
                    "Hanya menghemat biaya transportasi",
                    "Mengurangi kemacetan dan emisi karbon di seluruh pulau",
                    "Membuat jalanan lebih ramai",
                    "Tidak ada dampak signifikan"
                ],
                correct: 1,
                level: "Abstrak Meluas"
            }
        ];

        let currentQuestionIndex = 0;
        let studentLevel = 'Belum Dinilai';
        let lastCorrectLevel = 'Belum Dinilai';
        let materialPages = [];
        let currentPageIndex = 0;
        let timeInterval;

        // API endpoint
        const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwPnL4SL0fdtlvvqHDBmv168Jd-z3XSitiHnWS9pflgmLnQj62dOIiO1JpbXCmgbzQF/exec';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Focus tracking
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('blur', handleWindowBlur);
            window.addEventListener('focus', handleWindowFocus);
            
            // Check if student data exists in localStorage
            const savedData = localStorage.getItem('studentData');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                if (parsed.name) {
                    studentData = { ...studentData, ...parsed };
                    checkExistingAssessment();
                }
            }
        });

        function handleVisibilityChange() {
            if (document.hidden) {
                studentData.isActive = false;
                pauseTimer();
            } else {
                studentData.isActive = true;
                resumeTimer();
            }
        }

        function handleWindowBlur() {
            studentData.isActive = false;
            pauseTimer();
        }

        function handleWindowFocus() {
            studentData.isActive = true;
            resumeTimer();
        }

        function startTimer() {
            if (!studentData.startTime) {
                studentData.startTime = Date.now();
            }
            
            timeInterval = setInterval(() => {
                if (studentData.isActive) {
                    const elapsed = Date.now() - studentData.startTime + studentData.totalTime;
                    updateTimeDisplay(elapsed);
                }
            }, 1000);
        }

        function pauseTimer() {
            if (timeInterval) {
                clearInterval(timeInterval);
                if (studentData.startTime) {
                    studentData.totalTime += Date.now() - studentData.startTime;
                    studentData.startTime = null;
                }
            }
        }

        function resumeTimer() {
            if (!studentData.startTime && studentData.isActive) {
                studentData.startTime = Date.now();
            }
        }

        function updateTimeDisplay(totalMs) {
            const hours = Math.floor(totalMs / 3600000);
            const minutes = Math.floor((totalMs % 3600000) / 60000);
            const seconds = Math.floor((totalMs % 60000) / 1000);
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timeSpent').textContent = timeString;
        }

        function submitName() {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Silakan masukkan nama kamu terlebih dahulu!');
                return;
            }
            
            studentData.name = name;
            document.getElementById('studentName').textContent = name;
            
            // Save to localStorage
            localStorage.setItem('studentData', JSON.stringify(studentData));
            
            checkExistingAssessment();
        }

        async function checkExistingAssessment() {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify({
                        action: 'checkStudent',
                        name: studentData.name
                    })
                });
                
                const data = await response.json();
                
                if (data.exists && data.level) {
                    studentData.hasAssessment = true;
                    studentData.level = data.level;
                    document.getElementById('studentLevel').textContent = data.level;
                    showLearningScreen();
                } else {
                    showAssessmentScreen();
                }
                
                // Show status bar and start timer
                document.getElementById('statusBar').classList.remove('hidden');
                startTimer();
                
            } catch (error) {
                console.error('Error checking student:', error);
                showAssessmentScreen();
                document.getElementById('statusBar').classList.remove('hidden');
                startTimer();
            }
        }

        function showAssessmentScreen() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('assessmentScreen').classList.remove('hidden');
            loadQuestion();
        }

        function showLearningScreen() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('assessmentScreen').classList.add('hidden');
            document.getElementById('learningScreen').classList.remove('hidden');
            loadMaterials();
        }

        function loadQuestion() {
            const container = document.getElementById('questionContainer');
            const question = assessmentQuestions[currentQuestionIndex];
            
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = assessmentQuestions.length;
            
            const progress = ((currentQuestionIndex + 1) / assessmentQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            container.innerHTML = `
                <div class="question-text">${question.question}</div>
                <div class="options">
                    ${question.options.map((option, index) => `
                        <div class="option" onclick="selectOption(${index})" data-index="${index}">
                            ${String.fromCharCode(65 + index)}. ${option}
                        </div>
                    `).join('')}
                </div>
                <button class="btn" onclick="submitAnswer()" style="margin-top: 20px;" disabled id="submitBtn">Jawab</button>
            `;
        }

        function selectOption(index) {
            // Remove previous selection
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            
            // Add selection to clicked option
            document.querySelector(`[data-index="${index}"]`).classList.add('selected');
            
            // Enable submit button
            document.getElementById('submitBtn').disabled = false;
        }

        function submitAnswer() {
            const selectedOption = document.querySelector('.option.selected');
            if (!selectedOption) return;
            
            const selectedIndex = parseInt(selectedOption.dataset.index);
            const question = assessmentQuestions[currentQuestionIndex];
            
            // Check if answer is correct and update level based on SOLO taxonomy
            if (selectedIndex === question.correct) {
                // Determine level based on question number (following the SOLO progression)
                if (currentQuestionIndex <= 1) {
                    lastCorrectLevel = "Uni-struktural";
                } else if (currentQuestionIndex <= 3) {
                    lastCorrectLevel = "Multi-struktural";
                } else if (currentQuestionIndex <= 5) {
                    lastCorrectLevel = "Relasional";
                } else {
                    lastCorrectLevel = "Abstrak Meluas";
                }
            }
            // If answer is wrong, level stays at the last correct level
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex < assessmentQuestions.length) {
                // Continue to next question
                setTimeout(() => {
                    loadQuestion();
                }, 500);
            } else {
                // Assessment complete
                completeAssessment();
            }
        }

        async function completeAssessment() {
            studentData.level = lastCorrectLevel;
            studentData.hasAssessment = true;
            
            document.getElementById('studentLevel').textContent = studentData.level;
            
            // Save assessment result
            try {
                await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify({
                        action: 'saveAssessment',
                        name: studentData.name,
                        level: studentData.level,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.error('Error saving assessment:', error);
            }
            
            // Save to localStorage
            localStorage.setItem('studentData', JSON.stringify(studentData));
            
            // Show completion message then proceed to learning
            document.getElementById('questionContainer').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3>🎉 Asesmen Selesai!</h3>
                    <p>Level kemampuan kamu: <strong>${studentData.level}</strong></p>
                    <p>Sekarang mari kita mulai belajar materi Pepadu Karbon!</p>
                    <button class="btn btn-success" onclick="showLearningScreen()">Mulai Belajar 📚</button>
                </div>
            `;
        }

        async function loadMaterials() {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify({
                        action: 'getMaterials'
                    })
                });
                
                const data = await response.json();
                
                if (data.materials && data.materials.length > 0) {
                    materialPages = data.materials.sort((a, b) => a.page - b.page);
                    displayFlipbook();
                } else {
                    // Fallback with sample data
                    materialPages = [
                        { page: 1, imageUrl: 'https://via.placeholder.com/800x600/4299e1/ffffff?text=Halaman+1%0APengenalan+Pepadu+Karbon' },
                        { page: 2, imageUrl: 'https://via.placeholder.com/800x600/48bb78/ffffff?text=Halaman+2%0ASiklus+Karbon' },
                        { page: 3, imageUrl: 'https://via.placeholder.com/800x600/ed8936/ffffff?text=Halaman+3%0AEfek+Rumah+Kaca' }
                    ];
                    displayFlipbook();
                }
            } catch (error) {
                console.error('Error loading materials:', error);
                // Show error message
                document.getElementById('flipbookContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e53e3e;">
                        <h3>⚠️ Gagal Memuat Materi</h3>
                        <p>Terjadi kesalahan saat memuat materi pembelajaran. Silakan coba lagi nanti.</p>
                    </div>
                `;
            }
        }

        function displayFlipbook() {
            const container = document.getElementById('flipbookContent');
            const controls = document.getElementById('flipbookControls');
            
            if (materialPages.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px;">Tidak ada materi tersedia.</div>';
                return;
            }
            
            // Create pages
            container.innerHTML = materialPages.map((page, index) => `
                <div class="flipbook-page ${index === 0 ? 'active' : ''}" id="page-${index}">
                    <img src="${page.imageUrl}" alt="Halaman ${page.page}" onerror="this.src=''; this.alt='Gambar gagal dimuat'; this.style.display='none';">
                </div>
            `).join('');
            
            // Update page info
            document.getElementById('currentPage').textContent = '1';
            document.getElementById('totalPages').textContent = materialPages.length;
            
            // Show controls
            controls.classList.remove('hidden');
            updateNavigationButtons();
        }

        function previousPage() {
            if (currentPageIndex > 0) {
                document.getElementById(`page-${currentPageIndex}`).classList.remove('active');
                currentPageIndex--;
                document.getElementById(`page-${currentPageIndex}`).classList.add('active');
                document.getElementById('currentPage').textContent = currentPageIndex + 1;
                updateNavigationButtons();
            }
        }

        function nextPage() {
            if (currentPageIndex < materialPages.length - 1) {
                document.getElementById(`page-${currentPageIndex}`).classList.remove('active');
                currentPageIndex++;
                document.getElementById(`page-${currentPageIndex}`).classList.add('active');
                document.getElementById('currentPage').textContent = currentPageIndex + 1;
                updateNavigationButtons();
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentPageIndex === 0;
            nextBtn.disabled = currentPageIndex === materialPages.length - 1;
        }

        // Save learning time periodically
        setInterval(async () => {
            if (studentData.name && studentData.isActive) {
                const totalTime = studentData.totalTime + (studentData.startTime ? Date.now() - studentData.startTime : 0);
                
                try {
                    await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8'
                        },
                        body: JSON.stringify({
                            action: 'saveTime',
                            name: studentData.name,
                            timeSpent: Math.floor(totalTime / 1000), // in seconds
                            timestamp: new Date().toISOString()
                        })
                    });
                } catch (error) {
                    console.error('Error saving time:', error);
                }
            }
        }, 30000); // Save every 30 seconds

        // Learning content management
        function showContent(contentType) {
            // Update menu buttons
            document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide all content sections first
            document.getElementById('flipbookSection').classList.add('hidden');
            document.getElementById('videoSection').classList.add('hidden');
            document.getElementById('gamesSection').classList.add('hidden');
            
            // Show selected content section
            if (contentType === 'flipbook') {
                document.getElementById('flipbookSection').classList.remove('hidden');
            } else if (contentType === 'videos') {
                document.getElementById('videoSection').classList.remove('hidden');
                // Pause all videos when switching to video section
                pauseAllVideos();
            } else if (contentType === 'games') {
                document.getElementById('gamesSection').classList.remove('hidden');
                // Pause all videos when switching to games section
                pauseAllVideos();
            }
        }

        function toggleVideo(videoId) {
            const videoContent = document.getElementById(videoId);
            const toggleIcon = videoContent.previousElementSibling.querySelector('.toggle-icon');
            
            // Close all other videos first
            document.querySelectorAll('.video-content').forEach(content => {
                if (content.id !== videoId) {
                    content.classList.remove('active');
                    const icon = content.previousElementSibling.querySelector('.toggle-icon');
                    icon.textContent = '▶️';
                    // Pause the video
                    const video = content.querySelector('video');
                    if (video) video.pause();
                }
            });
            
            // Toggle current video
            if (videoContent.classList.contains('active')) {
                videoContent.classList.remove('active');
                toggleIcon.textContent = '▶️';
                // Pause the video
                const video = videoContent.querySelector('video');
                if (video) video.pause();
            } else {
                videoContent.classList.add('active');
                toggleIcon.textContent = '🔽';
            }
        }

        function pauseAllVideos() {
            document.querySelectorAll('video').forEach(video => {
                video.pause();
            });
        }



        // Save data before page unload
        window.addEventListener('beforeunload', () => {
            pauseTimer();
            pauseAllVideos();
            localStorage.setItem('studentData', JSON.stringify(studentData));
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98ffab0a97bd4f19',t:'MTc2MDcwMjc2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
